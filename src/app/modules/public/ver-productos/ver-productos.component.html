<!-- Contenedor principal siguiendo el patrón establecido -->
<div class="page-shell" [class.webview-mode]="isWebView">
  <!-- Header del menú con partículas animadas -->
  <div class="menu-hero position-relative overflow-hidden">
    <div class="particles-bg" aria-hidden="true"></div>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
          <header class="text-center rise-on-mount">
            <h1 class="section-title">Nuestro Menú</h1>
            <p class="subtitle">Descubre sabores únicos y auténticos de Colombia</p>
          </header>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="container-fluid px-3 px-lg-4">
    <!-- Loading spinner -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="loading-spinner">
        <i class="fas fa-utensils fa-spin"></i>
        <p>Cargando deliciosos productos...</p>
      </div>
    </div>

    <!-- Card principal con efectos visuales mejorados -->
    <div class="card-glass glow-border rise-on-mount" *ngIf="!isLoading">
      <!-- Barra de búsqueda inteligente mejorada -->
      <div class="row justify-content-center mb-4">
        <div class="col-lg-10 col-md-12">
          <div class="search-container-enhanced position-relative">
            <!-- Búsqueda principal con efectos visuales -->
            <div class="search-input-wrapper glow-on-focus">
              <i class="fas fa-search search-icon pulse-on-focus"></i>
              <input
                #searchInput
                type="text"
                class="search-input form-control-enhanced"
                placeholder="Buscar productos por nombre, categoría o ingredientes..."
                [value]="searchFilters.query"
                (input)="onSearchInput($event)"
                (focus)="onSearchFocus()"
                (blur)="onSearchBlur()"
                aria-label="Búsqueda inteligente de productos"
                autocomplete="off"
              />
              <button
                class="search-clear btn-floating"
                *ngIf="searchFilters.query"
                (click)="clearSearch()"
                aria-label="Limpiar búsqueda"
              >
                <i class="fas fa-times"></i>
              </button>

              <!-- Indicador de búsqueda activa -->
              <div class="search-indicator" *ngIf="isSearching">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
            </div>

            <!-- Búsqueda rápida por voz (sorpresa) -->
            <button
              class="voice-search-btn btn-floating"
              (click)="startVoiceSearch()"
              *ngIf="isVoiceSearchSupported"
              [disabled]="isVoiceSearching"
              aria-label="Búsqueda por voz"
              title="Buscar por voz"
            >
              <i
                class="fas"
                [ngClass]="isVoiceSearching ? 'fa-microphone-slash fa-pulse' : 'fa-microphone'"
              ></i>
            </button>

            <!-- Sugerencias de búsqueda -->
            <div class="search-suggestions" *ngIf="showSuggestions && searchSuggestions.length > 0">
              <div
                class="suggestion-item"
                *ngFor="let suggestion of searchSuggestions"
                (click)="selectSuggestion(suggestion)"
              >
                <i
                  class="fas"
                  [ngClass]="{
                    'fa-tag': suggestion.type === 'category',
                    'fa-utensils': suggestion.type === 'product',
                    'fa-leaf': suggestion.type === 'dietary',
                  }"
                ></i>
                <span class="suggestion-text">{{ suggestion.text }}</span>
                <span class="suggestion-count">{{ suggestion.count }}</span>
              </div>
            </div>

            <!-- Historial de búsqueda -->
            <div
              class="search-history"
              *ngIf="showSuggestions && searchHistory.length > 0 && !searchFilters.query"
            >
              <div class="history-header">
                <i class="fas fa-history"></i>
                <span>Búsquedas recientes</span>
                <button class="clear-history" (click)="clearSearch()">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
              <div
                class="history-item"
                *ngFor="let term of searchHistory"
                (click)="selectSuggestion({ text: term, type: 'product', count: 0 })"
              >
                <i class="fas fa-history"></i>
                <span>{{ term }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtros horizontales debajo de la búsqueda (solo Web Desktop >= 992px) -->
      <div class="row justify-content-center mb-3 d-none d-lg-flex">
        <div class="col-lg-10">
          <div class="filters-horizontal">
            <!-- Filtro por categoría -->
            <select
              class="filter-select-horizontal"
              [(ngModel)]="searchFilters.category"
              (change)="onCategoryChange($any($event.target).value)"
            >
              <option value="">Categoría</option>
              <option *ngFor="let category of getUniqueCategories()" [value]="category">
                {{ category }}
              </option>
            </select>

            <!-- Filtro por subcategoría -->
            <select
              class="filter-select-horizontal"
              *ngIf="searchFilters.category"
              [(ngModel)]="searchFilters.subcategory"
              (change)="onSubcategoryChange($any($event.target).value)"
            >
              <option value="">Subcategoría</option>
              <option
                *ngFor="let subcategory of getSubcategoriesForCategory(searchFilters.category)"
                [value]="subcategory"
              >
                {{ subcategory }}
              </option>
            </select>

            <!-- Filtro por calorías con float labels -->
            <div class="input-float-compact">
              <input
                type="number"
                class="filter-input-horizontal"
                placeholder=" "
                [(ngModel)]="searchFilters.caloriesRange.min"
                (input)="
                  onCaloriesRangeChange(+$any($event.target).value, searchFilters.caloriesRange.max)
                "
              />
              <label class="float-label-compact">
                <i class="fas fa-fire"></i>
                Calorías mín
              </label>
            </div>
            <div class="input-float-compact">
              <input
                type="number"
                class="filter-input-horizontal"
                placeholder=" "
                [(ngModel)]="searchFilters.caloriesRange.max"
                (input)="
                  onCaloriesRangeChange(searchFilters.caloriesRange.min, +$any($event.target).value)
                "
              />
              <label class="float-label-compact">
                <i class="fas fa-fire"></i>
                Calorías máx
              </label>
            </div>

            <!-- Ordenar por con float label -->
            <div class="input-float-compact select-wrapper">
              <select
                class="filter-select-horizontal"
                [(ngModel)]="searchFilters.sortBy"
                (change)="onSortChange($any($event.target).value)"
              >
                <option value="name">Nombre</option>
                <option value="price">Precio</option>
                <option value="calories">Calorías</option>
              </select>
              <label class="float-label-compact float-label-select">
                <i class="fas fa-sort"></i>
                Ordenar por
              </label>
            </div>

            <!-- Botón de dirección de orden -->
            <button
              class="sort-direction-btn-horizontal"
              (click)="toggleSortDirection()"
              [attr.aria-label]="sortDirection === 'asc' ? 'Orden ascendente' : 'Orden descendente'"
              title="{{ sortDirection === 'asc' ? 'Menor a mayor' : 'Mayor a menor' }}"
            >
              <i
                class="fas"
                [ngClass]="sortDirection === 'asc' ? 'fa-arrow-up' : 'fa-arrow-down'"
              ></i>
            </button>

            <!-- Botón limpiar filtros -->
            <button
              class="clear-filters-btn-horizontal"
              (click)="clearAllFilters()"
              *ngIf="getActiveFiltersCount() > 0"
              title="Limpiar todos los filtros"
            >
              <i class="fas fa-times-circle"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Controles mejorados con animaciones (solo WebView y Mobile) -->
      <div class="row justify-content-center mb-4 d-lg-none">
        <div class="col-lg-10 col-md-12">
          <div class="filters-controls-enhanced">
            <!-- Información de resultados con animación -->
            <div class="results-info-enhanced">
              <div class="results-count-wrapper">
                <span class="results-count animate-number" [attr.data-count]="totalProductos">
                  {{ totalProductos }} productos
                </span>
                <span class="results-subtitle" *ngIf="searchFilters.query">
                  para "{{ searchFilters.query }}"
                </span>
              </div>

              <!-- Filtros rápidos por categoría -->
              <div class="quick-filters d-flex gap-2 mt-2" *ngIf="!showAdvancedFilters">
                <button
                  class="quick-filter-chip"
                  [class.active]="!searchFilters.category"
                  (click)="onCategoryChange('')"
                >
                  <i class="fas fa-utensils"></i>
                  Todos
                </button>
                <button
                  class="quick-filter-chip"
                  *ngFor="let category of categorias.slice(0, 4)"
                  [class.active]="searchFilters.category === category"
                  (click)="onCategoryChange(category)"
                >
                  <i class="fas" [ngClass]="getCategoryIcon(category)"></i>
                  {{ category }}
                </button>
                <button
                  class="quick-filter-chip more-categories"
                  *ngIf="categorias.length > 4"
                  (click)="toggleAdvancedFilters()"
                >
                  <i class="fas fa-plus"></i>
                  +{{ categorias.length - 4 }}
                </button>
              </div>
            </div>

            <!-- Controles de vista mejorados (solo WebView y Mobile) -->
            <div class="view-controls-enhanced d-lg-none">
              <!-- Ordenamiento rápido -->
              <div class="sort-dropdown dropdown">
                <button
                  class="btn-floating dropdown-toggle"
                  type="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  aria-label="Ordenar productos"
                >
                  <i class="fas fa-sort-amount-down"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li *ngFor="let option of sortOptions">
                    <button
                      class="dropdown-item"
                      [class.active]="searchFilters.sortBy === option.value"
                      (click)="onSortChange(option.value, 'asc')"
                    >
                      <i class="fas" [ngClass]="option.icon"></i>
                      {{ option.label }}
                    </button>
                  </li>
                </ul>
              </div>

              <!-- Vista grid/list -->
              <div class="view-toggle-group">
                <button
                  class="btn-floating"
                  [class.active]="viewMode === 'grid'"
                  (click)="setViewMode('grid')"
                  aria-label="Vista de cuadrícula"
                >
                  <i class="fas fa-th"></i>
                </button>
                <button
                  class="btn-floating"
                  [class.active]="viewMode === 'list'"
                  (click)="setViewMode('list')"
                  aria-label="Vista de lista"
                >
                  <i class="fas fa-list"></i>
                </button>
              </div>

              <!-- Botón de filtros avanzados (solo WebView y Web Mobile) -->
              <button
                class="btn-floating filters-toggle"
                (click)="toggleAdvancedFilters()"
                [class.active]="showAdvancedFilters"
                aria-label="Filtros avanzados"
              >
                <i class="fas fa-sliders-h"></i>
                <span class="filter-badge" *ngIf="getActiveFiltersCount() > 0">{{
                  getActiveFiltersCount()
                }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtros avanzados desplegables (solo WebView y Web Mobile) -->
      <div class="row justify-content-center mb-4" *ngIf="showAdvancedFilters">
        <div class="col-lg-10">
          <div class="advanced-filters">
            <div class="filters-grid">
              <!-- Filtro por categoría -->
              <div class="filter-group">
                <label class="filter-label">Categoría</label>
                <select
                  class="filter-select"
                  [(ngModel)]="searchFilters.category"
                  (change)="onCategoryChange($any($event.target).value)"
                >
                  <option value="">Todas las categorías</option>
                  <option *ngFor="let category of getUniqueCategories()" [value]="category">
                    {{ category }}
                  </option>
                </select>
              </div>

              <!-- Filtro por subcategoría -->
              <div class="filter-group" *ngIf="searchFilters.category">
                <label class="filter-label">Subcategoría</label>
                <select
                  class="filter-select"
                  [(ngModel)]="searchFilters.subcategory"
                  (change)="onSubcategoryChange($any($event.target).value)"
                >
                  <option value="">Todas las subcategorías</option>
                  <option
                    *ngFor="let subcategory of getSubcategoriesForCategory(searchFilters.category)"
                    [value]="subcategory"
                  >
                    {{ subcategory }}
                  </option>
                </select>
              </div>

              <!-- Filtro por calorías con float labels -->
              <div class="filter-group">
                <div class="range-inputs-float">
                  <div class="input-float-compact">
                    <input
                      type="number"
                      class="range-input"
                      placeholder=" "
                      [(ngModel)]="searchFilters.caloriesRange.min"
                      (input)="
                        onCaloriesRangeChange(
                          +$any($event.target).value,
                          searchFilters.caloriesRange.max
                        )
                      "
                    />
                    <label class="float-label-compact">
                      <i class="fas fa-fire"></i>
                      Calorías mín
                    </label>
                  </div>
                  <span class="range-separator">-</span>
                  <div class="input-float-compact">
                    <input
                      type="number"
                      class="range-input"
                      placeholder=" "
                      [(ngModel)]="searchFilters.caloriesRange.max"
                      (input)="
                        onCaloriesRangeChange(
                          searchFilters.caloriesRange.min,
                          +$any($event.target).value
                        )
                      "
                    />
                    <label class="float-label-compact">
                      <i class="fas fa-fire"></i>
                      Calorías máx
                    </label>
                  </div>
                </div>
              </div>

              <!-- Ordenamiento con dirección -->
              <div class="filter-group">
                <label class="filter-label">Ordenar por</label>
                <div class="sort-control-group">
                  <select
                    class="filter-select"
                    [(ngModel)]="searchFilters.sortBy"
                    (change)="onSortChange($any($event.target).value)"
                  >
                    <option value="name">Nombre</option>
                    <option value="price">Precio</option>
                    <option value="calories">Calorías</option>
                  </select>
                  <button
                    class="sort-direction-btn"
                    (click)="toggleSortDirection()"
                    [attr.aria-label]="
                      sortDirection === 'asc' ? 'Orden ascendente' : 'Orden descendente'
                    "
                    title="{{ sortDirection === 'asc' ? 'Menor a mayor' : 'Mayor a menor' }}"
                  >
                    <i
                      class="fas"
                      [ngClass]="sortDirection === 'asc' ? 'fa-arrow-up' : 'fa-arrow-down'"
                    ></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="filters-actions">
              <button class="clear-filters-btn" (click)="clearAllFilters()">
                <i class="fas fa-eraser"></i>
                Limpiar filtros
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Banner informativo de favoritos -->
      <div class="favorites-info-banner" *ngIf="hasFavorites()">
        <i class="fas fa-star"></i>
        <span>Tus favoritos aparecen primero para tu comodidad</span>
      </div>

      <!-- Grid de productos con animaciones mejoradas -->
      <div class="products-container-enhanced">
        <!-- Transición suave entre vistas -->
        <div
          class="products-grid"
          [ngClass]="{
            'grid-view': viewMode === 'grid',
            'list-view': viewMode === 'list',
            loading: isLoading,
          }"
        >
          <!-- Tarjetas de productos mejoradas -->
          <div
            class="product-item"
            [ngClass]="{
              'list-layout': viewMode === 'list',
            }"
            *ngFor="let producto of productosPaginados; trackBy: trackByProductId; let i = index"
            [style.animation-delay]="i * 0.1 + 's'"
          >
            <article
              class="product-card-enhanced card-glass"
              [class.list-layout]="viewMode === 'list'"
              (click)="abrirDetalle(producto)"
              role="button"
              tabindex="0"
              [attr.aria-label]="'Ver detalles de ' + producto.nombre"
              (keydown.enter)="abrirDetalle(producto)"
              (keydown.space)="abrirDetalle(producto)"
            >
              <!-- Imagen con efectos hover mejorados -->
              <div class="product-image-container">
                <div class="product-image-wrapper">
                  <img
                    [src]="producto.imagen || defaultProductImage"
                    [alt]="producto.nombre"
                    loading="lazy"
                    class="product-image"
                    (error)="onProductImageError($event)"
                  />
                </div>

                <!-- Badges mejorados -->
                <div class="product-badges">
                  <span class="badge price-badge bg-success">
                    ${{ producto.precio | number: '1.0-0' }}
                  </span>
                </div>

                <!-- Botón de favoritos mejorado -->
                <button
                  class="favorite-btn-enhanced"
                  [class.active]="isFavorite(producto.productoId || 0)"
                  (click)="$event.stopPropagation(); toggleFavorite(producto)"
                  [attr.aria-label]="
                    isFavorite(producto.productoId || 0)
                      ? 'Quitar de favoritos'
                      : 'Agregar a favoritos'
                  "
                >
                  <i class="fas fa-heart"></i>
                  <span class="favorite-ripple"></span>
                </button>
              </div>

              <!-- Contenido del producto mejorado -->
              <div class="product-content-enhanced">
                <header class="product-header">
                  <h3 class="product-title">{{ producto.nombre }}</h3>
                </header>

                <!-- Solo calorías - Diseño simplificado para Web y WebView -->
                <div class="product-meta-enhanced">
                  <div class="meta-item" *ngIf="producto.calorias">
                    <i class="fas fa-fire text-orange"></i>
                    <span>{{ producto.calorias }} cal</span>
                  </div>
                  <!-- Stock disponible (solo para ADMIN) -->
                  <div
                    class="meta-item"
                    *ngIf="userRole === 'Administrador' && producto.cantidad !== undefined"
                  >
                    <i
                      class="fas fa-boxes"
                      [class.text-danger]="producto.cantidad <= 10"
                      [class.text-warning]="producto.cantidad > 10 && producto.cantidad <= 20"
                      [class.text-success]="producto.cantidad > 20"
                    ></i>
                    <span
                      [class.text-danger]="producto.cantidad <= 10"
                      [class.text-warning]="producto.cantidad > 10 && producto.cantidad <= 20"
                    >
                      {{ producto.cantidad }} disponibles
                    </span>
                  </div>
                </div>
              </div>
            </article>
          </div>
        </div>

        <!-- Estado vacío mejorado -->
        <div class="empty-state" *ngIf="productosPaginados.length === 0 && !isLoading">
          <div class="empty-state-content rise-on-mount">
            <div class="empty-icon">
              <i class="fas fa-search-minus"></i>
            </div>
            <h3 class="empty-title">No encontramos lo que buscas</h3>
            <p class="empty-description">
              <span *ngIf="searchFilters.query"
                >No hay productos que coincidan con "{{ searchFilters.query }}"</span
              >
              <span *ngIf="!searchFilters.query && getActiveFiltersCount() > 0"
                >Intenta ajustar tus filtros</span
              >
              <span *ngIf="!searchFilters.query && getActiveFiltersCount() === 0"
                >Aún no hay productos disponibles</span
              >
            </p>

            <!-- Sugerencias inteligentes -->
            <div class="suggestions" *ngIf="getSearchSuggestions().length > 0">
              <p class="suggestions-title">Tal vez te interese:</p>
              <div class="suggestions-chips">
                <button
                  class="suggestion-chip"
                  *ngFor="let suggestion of getSearchSuggestions()"
                  (click)="applySuggestion(suggestion)"
                >
                  <i class="fas" [ngClass]="suggestion.icon"></i>
                  {{ suggestion.text }}
                </button>
              </div>
            </div>

            <div class="empty-actions">
              <button
                class="btn btn-primary"
                (click)="clearAllFilters()"
                *ngIf="getActiveFiltersCount() > 0"
              >
                <i class="fas fa-eraser"></i>
                Limpiar filtros
              </button>
              <button class="btn btn-outline-primary" (click)="showAllProducts()">
                <i class="fas fa-utensils"></i>
                Ver todos los productos
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Paginación moderna con efectos visuales -->
      <div class="pagination-container-enhanced" *ngIf="totalPaginas > 1 && !isLoading">
        <nav class="pagination-nav-enhanced" aria-label="Navegación de páginas">
          <!-- Información de paginación mejorada -->
          <div class="pagination-info-enhanced">
            <div class="page-indicator">
              <span class="current-page">{{ paginaActual }}</span>
              <span class="page-separator">de</span>
              <span class="total-pages">{{ totalPaginas }}</span>
            </div>
            <div class="results-summary">
              Mostrando {{ (paginaActual - 1) * productosPorPagina + 1 }} -
              {{ Math.min(paginaActual * productosPorPagina, totalProductos) }}
              de {{ totalProductos }} productos
            </div>
            <!-- Selector de items por página -->
            <div class="items-per-page-selector" *ngIf="totalProductos > 12">
              <label for="itemsPerPage" class="items-label">Mostrar:</label>
              <select
                id="itemsPerPage"
                class="items-select"
                [(ngModel)]="productosPorPagina"
                (change)="changeItemsPerPage(productosPorPagina)"
              >
                <option *ngFor="let option of itemsPerPageOptions" [value]="option">
                  {{ option }}
                </option>
              </select>
            </div>
          </div>

          <!-- Controles de paginación mejorados -->
          <div class="pagination-controls-enhanced">
            <!-- Botón primera página -->
            <button
              class="pagination-btn btn-floating"
              [disabled]="paginaActual === 1"
              (click)="goToPage(1)"
              aria-label="Primera página"
              title="Primera página"
            >
              <i class="fas fa-angle-double-left"></i>
            </button>

            <!-- Botón página anterior -->
            <button
              class="pagination-btn btn-floating"
              [disabled]="paginaActual === 1"
              (click)="goToPage(paginaActual - 1)"
              aria-label="Página anterior"
              title="Página anterior"
            >
              <i class="fas fa-chevron-left"></i>
            </button>

            <!-- Números de página con animaciones -->
            <div class="pagination-numbers-enhanced">
              <button
                class="pagination-number btn-floating"
                *ngFor="let pagina of paginasVisibles"
                [class.active]="pagina === paginaActual"
                [class.ellipsis]="pagina === '...'"
                [disabled]="pagina === '...'"
                (click)="goToPage(pagina)"
                [attr.aria-label]="pagina === '...' ? 'Más páginas' : 'Ir a página ' + pagina"
                [attr.aria-current]="pagina === paginaActual ? 'page' : null"
              >
                {{ pagina }}
                <span class="page-ripple" *ngIf="pagina !== '...'"></span>
              </button>
            </div>

            <!-- Botón página siguiente -->
            <button
              class="pagination-btn btn-floating"
              [disabled]="paginaActual === totalPaginas"
              (click)="goToPage(paginaActual + 1)"
              aria-label="Página siguiente"
              title="Página siguiente"
            >
              <i class="fas fa-chevron-right"></i>
            </button>

            <!-- Botón última página -->
            <button
              class="pagination-btn btn-floating"
              [disabled]="paginaActual === totalPaginas"
              (click)="goToPage(totalPaginas)"
              aria-label="Última página"
              title="Última página"
            >
              <i class="fas fa-angle-double-right"></i>
            </button>
          </div>

          <!-- Salto rápido a página (sorpresa) -->
          <div class="quick-jump" *ngIf="totalPaginas > 10">
            <label for="pageJump" class="visually-hidden">Ir a página</label>
            <input
              type="number"
              id="pageJump"
              class="page-jump-input"
              [min]="1"
              [max]="totalPaginas"
              placeholder="Pág."
              (keydown.enter)="jumpToPage($any($event.target).value)"
            />
            <button
              class="btn-floating"
              (click)="jumpToPage(pageJumpValue)"
              aria-label="Ir a página"
            >
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </nav>
      </div>
    </div>
    <!-- Cierre de card-glass -->
  </div>

  <!-- Carrito flotante mejorado -->
  <app-floating-cart
    [isVisible]="userRole === 'Cliente'"
    [class.enhanced]="true"
    [style.z-index]="1050"
  >
  </app-floating-cart>

  <!-- Botón de volver arriba (sorpresa) -->
  <button
    class="scroll-to-top btn-floating"
    [class.visible]="showScrollToTop"
    (click)="scrollToTopPublic()"
    aria-label="Volver arriba"
    title="Volver arriba"
  >
    <i class="fas fa-arrow-up"></i>
  </button>

  <!-- Indicador de progreso de carga -->
  <div class="loading-progress" [class.visible]="isLoading">
    <div class="progress-bar"></div>
  </div>
</div>
